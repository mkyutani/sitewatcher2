name: OpenAPI Specification Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/openapi/**'
      - 'docs/swagger-ui/**'
      - '.github/workflows/openapi-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/openapi/**'
      - 'docs/swagger-ui/**'
      - '.github/workflows/openapi-validation.yml'

jobs:
  validate-openapi:
    name: Validate OpenAPI Specifications
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install validation tools
      run: |
        pip install pyyaml
        pip install openapi-spec-validator

    - name: Validate YAML syntax
      run: |
        echo "Validating YAML syntax for OpenAPI files..."
        python3 -c "
import yaml, sys, glob
files = glob.glob('docs/openapi/**/*.yaml', recursive=True) + glob.glob('docs/swagger-ui/*.yaml')
for file in files:
    try:
        with open(file, 'r') as f: yaml.safe_load(f)
        print(f'✅ {file}')
    except Exception as e:
        print(f'❌ {file}: {e}'); sys.exit(1)
"

    - name: Validate OpenAPI 3.0 compliance
      run: |
        echo "Validating OpenAPI 3.0 compliance..."
        python3 -c "
from openapi_spec_validator import validate_spec
from openapi_spec_validator.readers import read_from_filename
import sys
try:
    spec_dict, spec_url = read_from_filename('docs/swagger-ui/openapi-simple.yaml')
    validate_spec(spec_dict)
    print('✅ OpenAPI specification is valid')
except Exception as e:
    print(f'❌ OpenAPI validation failed: {e}'); sys.exit(1)
"

    - name: Summary Report
      run: |
        echo "## 📋 Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **YAML Syntax**: All files validated successfully" >> $GITHUB_STEP_SUMMARY
        echo "✅ **OpenAPI 3.0**: Specification compliance verified" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Validated:" >> $GITHUB_STEP_SUMMARY
        echo "- Main specification: \`docs/swagger-ui/openapi-simple.yaml\`" >> $GITHUB_STEP_SUMMARY
        echo "- Component files: \`docs/openapi/components/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Path definitions: \`docs/openapi/paths/\`" >> $GITHUB_STEP_SUMMARY