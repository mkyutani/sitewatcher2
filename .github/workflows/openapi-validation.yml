name: OpenAPI Specification Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/openapi/**'
      - 'docs/swagger-ui/**'
      - '.github/workflows/openapi-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/openapi/**'
      - 'docs/swagger-ui/**'
      - '.github/workflows/openapi-validation.yml'

jobs:
  validate-openapi:
    name: Validate OpenAPI Specifications
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install validation tools
      run: |
        pip install pyyaml
        pip install openapi-spec-validator

    - name: Validate YAML syntax
      run: |
        echo "Validating YAML syntax for OpenAPI files..."
        find docs/openapi -name "*.yaml" -exec python3 -c "import yaml; yaml.safe_load(open('{}'))" \; && echo "âœ… YAML syntax valid"
        python3 -c "import yaml; yaml.safe_load(open('docs/swagger-ui/openapi-simple.yaml'))" && echo "âœ… Swagger UI YAML valid"

    - name: Validate OpenAPI 3.0 compliance
      run: |
        echo "Validating OpenAPI 3.0 compliance..."
        pip show openapi-spec-validator > /dev/null && python3 -c "from openapi_spec_validator import validate_spec; from openapi_spec_validator.readers import read_from_filename; validate_spec(read_from_filename('docs/swagger-ui/openapi-simple.yaml')[0]); print('âœ… OpenAPI specification is valid')"

    - name: Summary Report
      run: |
        echo "## ðŸ“‹ Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **YAML Syntax**: All files validated successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **OpenAPI 3.0**: Specification compliance verified" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Validated:" >> $GITHUB_STEP_SUMMARY
        echo "- Main specification: \`docs/swagger-ui/openapi-simple.yaml\`" >> $GITHUB_STEP_SUMMARY
        echo "- Component files: \`docs/openapi/components/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Path definitions: \`docs/openapi/paths/\`" >> $GITHUB_STEP_SUMMARY